# Excel 处理工具项目报告

## 1. 项目概述
本项目是一个基于 Qt 5.12.12 和 C++ 开发的 Excel 数据处理工具，旨在提供灵活的规则配置、数据预览和自动化处理功能。项目采用 CMake 构建，支持 Windows 环境（Visual Studio 2026）。

## 2. 开发环境
- **操作系统**: Windows 10
- **IDE**: Visual Studio 2026
- **Qt 版本**: 5.12.12 (MSVC 2017 64-bit)
- **构建工具**: CMake + Ninja/NMake

## 3. 核心模块架构
### 3.1 核心逻辑 (`src/core`)
- **`ExcelProcessorCore`**: 核心处理引擎，负责 Excel 文件的读取、写入和任务调度。
- **`RuleEngine`**: 规则引擎，解析和执行用户定义的过滤/处理规则。
- **`RuleCombinationEngine`**: 负责多规则的组合逻辑。

### 3.2 图形界面 (`src/gui`)
- **`MainWindow`**: 主窗口，包含任务列表、规则列表、日志输出和预览面板。
- **`RuleEditDialog`**: 规则编辑对话框，支持多种规则类型的配置。

## 4. 功能特性
- **多模式处理**: 支持覆盖原工作表、新建工作表、新建工作簿等多种输出模式。
- **规则系统**: 支持“保留”、“删除”、“替换”等多种规则，支持多条件组合。
- **实时预览**: 能够预览 Excel 数据及规则应用后的效果。
- **日志系统**: 提供详细的操作日志，支持错误追踪。
- **配置持久化**: 自动保存和加载用户配置的任务和规则。

## 5. 开发日志与问题修复

### 5.1 初始开发
- 搭建 CMake 项目结构。
- 实现基础的 Excel 读取 (ActiveQt) 和写入功能。
- 实现 Qt 界面原型。

### 5.2 修复：规则应用逻辑
- **问题**: 多个规则按顺序应用时，数据状态未正确更新。
- **修复**: 重构 `RuleEngine::applyRules`，确保每条规则基于上一条规则的输出进行处理。

### 5.3 优化：大文件处理性能
- **问题**: 读取大型 Excel 文件时界面卡顿。
- **优化**: 引入分块读取 (Chunked Reading) 机制，配合多线程处理，保持界面响应。

### 5.4 修复：中文乱码问题
- **问题**: 规则名称和日志中的中文显示为乱码。
- **修复**: 统一使用 UTF-8 编码源文件，并在 CMake 中添加 `/utf-8` 编译选项。

### 5.5 新增：预览功能增强
- **需求**: 用户希望在预览时看到原始数据和处理后数据的对比。
- **实现**: 在 `MainWindow` 中添加两个 `QTableWidget`，分别显示输入预览和输出预览。

### 5.6 修复：输出模式“覆盖原工作表”逻辑
- **问题**: 选择覆盖原工作表时，程序错误地清空了整个文件。
- **修复**: 修改 `ActiveQtExcelWriter`，使用 `UsedRange.Clear()` 而不是删除 Sheet，保留了 Sheet 结构。

### 5.7 修复：规则添加成功提示乱码
- **问题描述**: 用户反馈添加规则成功后的提示框中出现乱码。
- **原因分析**: 源代码文件编码与编译器执行字符集不匹配，或 `QMessageBox` 未正确处理字符串编码。
- **修复方法**: 确保源文件为 UTF-8 BOM 格式，并使用 `QString::fromLocal8Bit` 或直接使用宽字符（如果适用）来处理中文字符串。在本项目中，统一确保源文件 UTF-8 编码并正确使用 Qt 的字符串处理机制。

### 5.8 修复：预览数据累加问题
- **问题描述**: 多次点击预览时，新的预览数据会追加在旧数据后面，而不是替换。
- **原因分析**: `getTaskPreviewData` 或 UI 更新逻辑中，未在填充新数据前清空容器或表格。
- **修复方法**: 在 `MainWindow::previewTask` 中，在加载新数据前调用 `previewInputTable_->setRowCount(0)` 和 `previewOutputTable_->setRowCount(0)` 清空表格。

### 5.9 修复：单独点击输出规则表头缺失
- **问题描述**: 当用户未点击“预览”而直接点击规则列表中的规则进行单步调试/输出时，结果中缺失表头。
- **原因分析**: 单步规则处理逻辑直接使用了 `processData` 对数据行进行处理，而未考虑到第一行可能是表头（需要特殊保留或处理）。
- **修复方法**: 在规则处理逻辑中增加对表头的判断。如果任务配置为 `useHeader`，则在处理第一行时将其标记为表头，不应用过滤/删除规则（除非规则显式针对表头）。

### 5.10 修复：预览界面缺失表头问题
- **问题描述**: 预览界面（输入和输出）均不显示 Excel 的表头行，导致用户难以对应列数据。
- **原因分析**: `ExcelProcessorCore::getTaskPreviewData` 在读取数据时，默认可能跳过了第一行（视作表头但未返回给 UI），或者 UI 在渲染时未将第一行数据设置为 `QTableWidget` 的 Header。
- **修复方法**: 修改数据读取逻辑，确保预览数据包含表头行。在 `MainWindow` 中，将读取到的第一行数据提取出来，使用 `setHorizontalHeaderLabels` 设置为表格的列头。

### 5.11 修复：刷新预览导致信息丢失
- **问题描述**: 用户在修改规则后点击刷新预览，之前的输入源/输出目标等上下文信息丢失，或预览内容未正确更新。
- **原因分析**: 刷新操作可能重新触发了完整的数据读取流程，但未保留当前选中的任务上下文。
- **修复方法**: 优化 `previewTask` 流程，确保在刷新时重新读取当前选中任务的配置，并保持界面状态一致。

### 5.12 改进：预览界面信息显示
- **需求**: 在预览界面清晰展示当前预览的是哪个文件（输入源）以及应用了哪些规则（输出规则）。
- **实现**: 
  - 在预览面板顶部增加 `QLabel`，显示“输入源: [文件名]”。
  - 增加显示“当前预览规则: [规则名称]”的标签。
  - 改进：在文件名后增加工作表名称，格式为“输入源: [文件名] / [工作表名]”。

### 5.13 修复：项目报告章节顺序错误
- **问题**: 项目报告中章节编号混乱（如 5.15 在 5.16 后）。
- **修复**: 重新整理 `ProjectReport.md`，按时间顺序和逻辑关系调整章节编号。

### 5.14 修复：编译错误 (Terminal#404-566)
- **问题描述**: 终端报错 `C2039: 'sheetName': is not a member of 'ProcessingTask'`。
- **原因分析**: 代码中引用了 `task.sheetName`，但 `ProcessingTask` 结构体的实际成员名为 `inputSheetName`。
- **修复方法**: 将 `MainWindow.cpp` 中所有错误的 `task.sheetName` 引用更正为 `task.inputSheetName`。

### 5.15 新增：程序图标
- **需求**: 为程序创建一个图标，构想为绿色背景上的大写字母 "E"，并要求设计更加绚丽，且调整 "E" 的笔画间距以避免拥挤。
- **实现**:
  - 编写 Python 脚本 `generate_icon.py`，使用 Pillow 库绘制图标。
  - **设计升级**:
    - **背景**: 采用 Excel 风格的绿色渐变 (从浅绿到深绿)，替代原本的单色背景。
    - **纹理**: 叠加了半透明的网格线，模拟电子表格的视觉效果。
    - **主体**: 白色的大写 "E" 字样，增加了阴影效果以提升立体感。
    - **结构优化**: 减小了边距 (`0.25` -> `0.20`) 和笔画粗细 (`0.15` -> `0.12`)，显著增加了 "E" 三横之间的垂直间距，使视觉效果更加舒展。
    - **边框**: 添加了微弱的半透明边框，增加精致感。
  - 生成包含多种尺寸 (16x16, 32x32, 48x48, 256x256) 的 `app_icon.ico` 文件。
  - 创建资源文件 `excel_gui.rc`，将图标链接到 Windows 可执行文件。
  - 修改 `CMakeLists.txt`，在 `excel_gui` 目标中添加资源文件引用。

### 5.16 修复：预览界面表头错位与 UsedRange 异常处理
- **问题描述**: 
  - 1. 用户反馈预览界面错误地使用第二行数据作为表头。
  - 2. 用户反馈在某些情况下，程序会错误地使用“第319行”数据作为表头，怀疑与 Excel 文件的脏数据或 `UsedRange` 异常有关。
- **原因分析**:
  - **预览表头错位**: `ExcelProcessorCore::loadFile` 在预览模式下调用时，使用了默认参数 `includeHeader=false`。这导致 `ActiveQtExcelReader` 在读取时自动跳过了第一行（将其视为表头并丢弃）。随后 `getTaskPreviewData` 获取到的数据实际上是从第二行开始的，它错误地将现在的第一行（原第二行）作为表头处理。
  - **第319行异常**: 怀疑 Excel 文件的 `UsedRange` 属性返回了非预期的起始行（例如前 318 行被删除但未重置），导致程序读取范围偏移。
- **修复方法**:
  - **修改核心接口**: 修改 `loadFile` 签名，增加 `includeHeader` 参数。
  - **强制读取表头**: 在 `previewResults` 中调用 `loadFile` 时，强制设置 `includeHeader=true`，确保内存中的数据完整包含 Excel 第一行。
  - **修正预览逻辑**: 更新 `getTaskPreviewData`，现在它能正确访问到真实的表头行（Row 0）。
  - **增强诊断能力**: 在 `ActiveQtExcelReader::readExcelFile` 中添加了详细的调试日志，记录 `UsedRange` 的起始行/列、计数、绝对读取位置以及被跳过的表头内容。这将帮助用户和开发者在未来遇到类似“第319行”问题时，通过日志快速定位是文件本身问题还是程序逻辑问题。

### 5.17 修复：ActiveQt 资源残留与空行计数逻辑
- **问题描述**: 用户反馈在进行一次“单任务处理”后，再次预览同一文件时，表头错位（数据行被当成表头），且日志显示读取到的数据是从第 319 行开始的（原表头行丢失）。
- **原因分析**:
  - **资源残留**: `processTasksInternal` 在处理完任务后，未释放 `writer_` 占用的 Excel 进程资源。导致后续读取同一文件时，可能因文件锁或 Excel 进程状态异常（如 UsedRange 偏移）而读取失败。
  - **空行计数 bug**: `ActiveQtExcelReader` 在读取时，如果遇到空行（ActiveQt 返回空 List），会执行 `continue` 跳过，但未增加 `rowIdx` 计数器。如果文件前 318 行是空的（或读取为空），它们被全部跳过，导致第 319 行（第一行数据）的逻辑行号变成了 1。
  - **表头丢失**: 由于 Row 319 变成了逻辑 Row 1，且 Row 1（真实表头）被跳过（可能因为读取异常为空），后续逻辑错误地将数据行（Row 319）作为表头处理。
- **修复方法**:
  - **释放资源**: 在 `processTasksInternal` 结束时显式调用 `writer_->closeAll()`，确保 Excel 进程及时关闭，文件锁释放。
  - **修正计数逻辑**: 在 `readExcelFile` 循环中，无论行是否为空，首先增加 `rowIdx`，确保行号与绝对位置同步。
  - **强制保留表头**: 增加逻辑，当 `includeHeader=true` 且当前是第一行（AbsRow=1）时，即使该行为空，也强制生成一个空的 `DataRow`。这确保了 `data` 向量的第一个元素始终对应 Excel 的第一行，防止数据行位移变成表头。

### 5.18 修复：配置保存丢失与表头日志增强
- **问题描述**:
  - 1. 用户反馈勾选“使用原表头信息”后，保存配置并重启软件，该选项丢失（复选框未勾选）。
  - 2. 用户请求在预览和处理日志中显示详细的表头读取信息，以便定位“表头为空”或“错位”等异常。
- **原因分析**:
  - **配置丢失**: `ExcelProcessorCore` 的 `loadConfiguration` 和 `saveConfiguration` 方法完全遗漏了 `task.useHeader` 字段的序列化与反序列化。
- **修复方法**:
  - **完善配置读写**: 修改 `ExcelProcessorCore.cpp`，在配置文件（CSV格式）的末尾增加 `UseHeader` 字段，确保该选项能被正确保存和恢复。
  - **增强日志**: 在 `loadFile` (用于预览) 和 `processTasksInternal` (用于处理) 中添加逻辑，当 `includeHeader=true` 时，显式记录读取到的第一行内容（表头），并检测其是否为空，以便用户在日志中直接确认表头读取状态。

### 5.19 修复：编译错误与构建优化
- **问题描述**:
  - 1. 编译报错 `C2065: “logger_”: 未声明的标识符`，发生在 `ActiveQtExcelReader` 中。
  - 2. 编译报错 `C7744: 字符串使用了非标准的转义符`，由于使用了十六进制转义序列表示中文。
  - 3. 构建产物过多，包含了 FLTK 等不需要的 exe 文件。
- **原因分析**:
  - **logger_**: `ActiveQtExcelReader` 是一个独立类，无法直接访问 `ExcelProcessorCore` 的 `logger_` 成员。
  - **转义符**: MSVC 对某些 Unicode 转义序列的支持或配置导致报错。
  - **构建目标**: `CMakeLists.txt` 中包含了 FLTK 的 FetchContent 和测试项目，导致生成了额外的可执行文件。
- **修复方法**:
  - **修复 logger_**: 移除 `ActiveQtExcelReader` 中无效的 `logger_` 调用，改用 `qDebug()` 或依赖上层调用者的日志（上层已添加详细表头日志）。
  - **修复转义符**: 将十六进制转义序列替换为 UTF-8 编码的中文面值字符串。
  - **构建优化**: 在 `CMakeLists.txt` 中注释掉 FLTK 的获取逻辑，并禁用测试相关目标 (`enable_testing`)，确保只生成 Qt 相关的核心程序。

### 5.20 修复：预览功能工作表读取错误
- **问题描述**: 用户反馈在预览指定任务（如“牛腿”）时，界面显示的数据来自默认工作表（如第一个Sheet），而非任务配置中指定的特定工作表（如"Sheet1"）。
- **原因分析**: `ExcelProcessorCore::previewResults` 接口在设计时未接收 `sheetName` 参数，内部调用 `loadFile` 时默认使用了空字符串作为 sheet 名，导致 `ActiveQtExcelReader` 默认加载第一个工作表。虽然任务配置中包含了 `inputSheetName`，但该信息未能传递到预览逻辑的最底层。
- **修复方法**:
  - **接口升级**: 修改 `ExcelProcessorCore` 的 `previewResults` 方法签名，增加 `sheetName` 参数。
  - **逻辑透传**: 在 `MainWindow::previewTask` 和 `previewData` 中，将任务配置中的 `inputSheetName` 提取并传递给 `previewResults`。
  - **底层实现**: 确保 `previewResults` 调用 `loadFile` 时正确传入指定的 `sheetName`，从而让 `ActiveQtExcelReader` 加载正确的工作表。

### 5.21 优化：界面文案更新
- **需求**: 用户请求将主界面标题及描述文案修改为更符合业务场景的内容。
- **实现**:
  - 将窗口标题和关于页标题修改为 "Excel数据快速处理"。
  - 将功能描述修改为 "Excel数据快速处理，自定义复杂规则输出数据"。
  - 解决了修改过程中因中文字符编码导致的编译错误，采用十六进制转义序列确保兼容性。

### 5.22 优化：界面标题定制
- **需求**: 用户要求将窗口标题修改为"Excel数据处理工具-横梁下料专业组"。
- **实现**:
  - 更新 `MainWindow.cpp` 中的 `setWindowTitle` 调用及关于页面的标题标签。
  - 继续沿用十六进制转义序列 (`\x...`) 以确保跨环境编译时中文不会出现乱码。
  - 新标题已成功应用并编译通过。

### 5.23 优化：预览行数限制调整
- **需求**: 用户请求将预览数据的行数限制从默认的 100 行增加到 5000 行，以便查看更多数据。
- **实现**:
  - **接口更新**: 修改 `ExcelProcessorCore.h` 中 `previewResults`, `getPreviewData`, `getProcessedPreviewData`, `getTaskPreviewData` 等方法的默认 `maxRows` 参数值为 5000。
  - **调用更新**: 更新 `MainWindow.cpp` 中 `previewTask` 和 `previewData` 方法对 `previewResults` 的调用，显式传递 5000 作为最大行数。
  - **效果**: 现在的预览功能将尝试读取并显示最多 5000 行数据。
