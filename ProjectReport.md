# Excel数据处理工具项目报告

## 1. 项目概述
本项目旨在开发一个基于 Qt (C++) 的 Excel 数据处理工具，用于横梁下料专业组的数据处理。该工具需要能够读取 Excel 文件，根据预设的规则对数据进行过滤、拆分、转换等操作，并将结果输出到新的 Excel 文件中。

## 2. 技术栈
- **编程语言**: C++17
- **GUI 框架**: Qt 5.12.12 (MSVC 2017 64bit)
- **Excel 操作**: ActiveQt (QAxObject)
- **构建工具**: CMake 3.29
- **编译器**: MSVC 2022 (v143)

## 3. 核心功能
1.  **Excel 文件读取**: 支持 `.xlsx` 和 `.xls` 格式。
2.  **规则配置**:
    -   **过滤规则**: 根据特定列的值过滤行。
    -   **删除规则**: 删除特定列或行。
    -   **拆分规则**: 根据特定列的值将数据拆分到不同的 Sheet 或文件。
    -   **转换规则**: 对特定列的数据进行格式转换（如日期格式、数值计算等）。
3.  **任务管理**: 支持多任务配置，每个任务可以应用不同的规则组合。
4.  **数据预览**: 实时预览规则应用后的效果。
5.  **批量处理**: 支持对文件夹内的多个文件进行批量处理。
6.  **日志记录**: 详细记录处理过程和错误信息。

## 4. 架构设计
-   **Model-View 架构**: 核心逻辑 (`ExcelProcessorCore`) 与 GUI (`MainWindow`) 分离。
-   **规则引擎**: 独立的规则引擎 (`RuleEngine`) 负责规则的解析和执行。
-   **插件化设计**: (可选) 未来可支持插件扩展新的规则类型。

## 5. 开发日志与问题修复

### 5.1 初始环境搭建
-   配置 CMakeLists.txt，包含 Qt5 模块 (Core, Widgets, Gui, AxContainer)。
-   解决 MSVC 编码问题 (`/utf-8`)。

### 5.2 核心类设计
-   `ExcelProcessorCore`: 负责协调读取、处理和写入。
-   `ActiveQtExcelReader`: 使用 ActiveX 对象读取 Excel。
-   `ActiveQtExcelWriter`: 使用 ActiveX 对象写入 Excel。

### 5.3 规则引擎实现
-   定义 `Rule` 结构体和 `RuleType` 枚举。
-   实现基本的过滤逻辑。

### 5.4 GUI 界面开发
-   主窗口布局：左侧配置区，右侧预览/日志区。
-   规则编辑对话框 (`RuleEditDialog`)。

### 5.5 遇到的问题：Excel 进程残留
-   **问题**: 程序退出后，后台仍有 Excel.exe 进程。
-   **原因**: `QAxObject` 未正确释放，或 `Quit()` 方法未被调用。
-   **解决**: 在析构函数中显式调用 `Quit()` 并释放所有 `QAxObject` 指针，使用 `CoUninitialize`。

### 5.6 遇到的问题：大文件读取慢
-   **问题**: 读取几万行的 Excel 文件时界面卡死。
-   **解决**:
    -   使用多线程 (`std::async` 或 `QThread`) 读取。
    -   优化读取逻辑，使用 `usedRange` 一次性读取整个区域的数据到 `QVariant`，而不是逐个单元格读取。

### 5.7 功能增强：多Sheet处理
-   支持选择输入文件的特定 Sheet。
-   支持将结果输出到不同的 Sheet。

### 5.8 修复：中文路径乱码
-   **问题**: 打开中文路径的文件失败。
-   **解决**: 使用 `QString::toLocal8Bit()` 或 `QString::toStdWString()` 转换路径传递给 ActiveQt。

### 5.9 优化：规则配置持久化
-   使用 CSV 或 JSON 格式保存规则配置。
-   实现了 `saveConfiguration` 和 `loadConfiguration`。

### 5.10 修复：规则条件为空时的崩溃
-   **问题**: 当规则条件为空字符串时，程序崩溃。
-   **解决**: 在 `RuleEngine` 中增加空值检查。

### 5.11 修复：ActiveQt "CoInitialize has not been called"
-   **问题**: 在子线程中使用 ActiveQt 报错。
-   **解决**: 在每个使用 ActiveQt 的线程入口处调用 `CoInitializeEx(NULL, COINIT_MULTITHREADED)`，退出时调用 `CoUninitialize`。

### 5.12 修复：保存文件时提示“文件已存在”
-   **问题**: `SaveAs` 方法在文件存在时会弹出对话框询问覆盖，阻塞程序。
-   **解决**: 在保存前检查文件是否存在，若存在则删除（或使用 `DisplayAlerts = false`）。

### 5.13 修复：内存泄漏
-   **问题**: 长时间运行后内存占用过高。
-   **解决**: 仔细检查 `QAxObject` 的生命周期，确保每个 `querySubObject` 返回的指针都被 `delete` 或使用 `QScopedPointer` 管理。

### 5.14 修复：规则优先级逻辑错误
-   **问题**: 规则执行顺序不符合预期。
-   **解决**: 在 `processFile` 中先对规则按优先级排序 (`std::sort`)。

### 5.15 完善图标资源
- 使用 Python 脚本生成了应用图标 (`resources/app_icon.ico`)。
- 在 `CMakeLists.txt` 中添加了资源文件编译规则。
- 编写 Python 脚本 `generate_icon.py`，使用 Pillow 库绘制图标。

### 5.16 修复：Excel 保存时 "Sheet1" 重复及文件覆盖问题
- **问题描述**: 
  1. 任务设置了 `outputWorkbookName`，但保存时未正确使用该名称，可能覆盖源文件。
  2. 新建工作簿时，默认创建了 "Sheet1"，数据写入时又创建了新 Sheet 或追加数据，导致混乱。
- **原因分析**: `ExcelProcessorCore.cpp` 中的 `writeExcelFile` 和 `appendToSheet` 逻辑对文件名和 Sheet 名称的处理存在分支遗漏。
- **修复方法**:
  1. 统一输出路径处理逻辑，确保 `NEW_WORKBOOK` 模式下使用正确的输出文件名。
  2. 优化 `ActiveQtExcelWriter`，在写入前检查目标 Sheet 是否存在，若不存在则创建，若存在则清空或追加（根据覆盖选项）。

### 5.17 新增：授权管理模块
- **需求**: 
  - 程序启动时检查授权状态。
  - 支持激活码激活，有效期 1 年。
  - 授权过期后限制功能或提示。
- **实现**:
  - 创建 `LicenseManager` 类 (Singleton)。
  - 使用 Windows Registry (`HKCU\Software\ExcelCL`) 存储加密的过期时间。
  - 使用 AES-256 加密存储敏感信息（过期时间）。
  - 集成到 `main.cpp` 和 `MainWindow`，启动时检查授权。

### 5.18 新增：授权码生成器与验证测试
- **需求**: 需要一个生成激活码的工具，并验证激活逻辑。
- **实现**:
  - **生成器工具 (`license_keygen`)**: 
    - 创建独立的命令行激活码生成工具 `license_keygen.exe`。
    - **功能**: 生成当前时间有效的激活码，用于分发给用户。
    - **体验优化**: 增加程序暂停机制 (`system("pause")`)，防止运行后窗口立即关闭，便于用户复制激活码。
- **验证**:
  - 通过 `license_test` 验证了激活码的生成与验证逻辑闭环。
  - 验证了与 C# 逻辑的算法一致性（使用相同的密钥源字符串）。

### 5.19 修复：输入表/工作表不存在的错误提示
- **问题描述**:
  1. 当指定的输入文件不存在时，程序日志无提示，且任务可能显示完成。
  2. 当输入文件存在但指定的工作表（或任务配置的工作表）不存在时，日志中仅显示警告或无提示，导致用户误以为任务已正确执行。
- **修复方法**:
  1. **输入文件检查**: 在 `processTasksInternal` 单文件处理流程开始处，增加 `QFileInfo::exists` 检查。若文件不存在，立即记录错误日志 (`addError`) 并终止处理。
  2. **工作表存在性验证**:
     - 在确定处理目标工作表前，先调用 `getSheetNames` 获取文件内实际存在的工作表列表。
     - 若用户指定了工作表名称但不在列表中，记录明确错误日志并终止。
     - 若任务配置了特定的 `inputSheetName` 但文件内不存在该 Sheet，记录错误日志并标记任务错误，避免静默失败。
  3. **多任务模式文件匹配检查**:
     - 在 `processTasksInternal` 的分发模式（Dispatcher Mode）下，增加对任务文件名模式匹配结果的检查。
     - 若某个任务未匹配到任何文件，记录警告日志。
     - 若所有启用任务均未匹配到任何文件，记录明确的错误日志并提示用户检查配置，防止程序静默退出而显示“任务完成”。

### 5.20 修复：规则配置中“分隔逻辑”保存未生效
- **问题描述**: 在规则配置界面修改“分隔逻辑”后，点击保存配置，文件中的数据未发生变化。重新加载配置后，分隔逻辑丢失（恢复为默认值）。
- **原因分析**: `ExcelProcessorCore` 中的 CSV 解析辅助函数 `splitString` 在分割字符串时错误地忽略了空 Token。当规则条件的 `value` 字段为空（常见于仅依赖分隔符逻辑的规则）时，导致后续的 `splitSymbol` 和 `splitTarget` 字段在读取时发生错位，从而未能正确加载。
- **修复方法**: 重写 `splitString` 函数，使用 `while` 循环和 `substr` 确保正确处理并保留空字符串 Token，保证 CSV 字段解析的位置准确性。

### 5.21 修复：配置持久化遗漏（规则逻辑、数据类型、任务状态）
- **问题描述**: 
  1. 用户修改规则逻辑（AND/OR）后无法保存。
  2. 规则条件的“数据类型”和“区分大小写”设置无法保存。
  3. 任务的“启用/禁用”状态无法保存，重启后总是默认为启用。
- **原因分析**: `ExcelProcessorCore` 的保存和加载逻辑中遗漏了 `RuleLogic`、`DataType`、`CaseSensitive` 以及 Task 的 `enabled` 字段。
- **修复方法**: 
  1. 在 CSV 配置文件中扩展字段，增加上述缺失属性的读写支持。
  2. 更新 `saveConfiguration` 和解析逻辑，确保所有属性正确序列化和反序列化。
  3. 保持向后兼容性，对旧版本配置文件提供默认值处理。

### 5.22 修复：编译错误与编码警告
- **问题描述**:
  1. 编译报错 `error C2146: 语法错误: 缺少“;”`。
  2. 编译警告 `warning C4819: 该文件包含不能在当前代码页(936)中表示的字符`。
- **原因分析**:
  1. `ExcelProcessorCore.cpp` 第 1247 行存在多余的 `file` 关键字（上次修改遗留）。
  2. 源代码文件使用 UTF-8 编码，但 MSVC 默认使用当前系统代码页 (GBK/936) 解析，导致中文字符识别警告。
- **修复方法**:
  1. 删除多余的代码。
  2. 在 `CMakeLists.txt` 中为 MSVC 添加 `/utf-8` 编译选项，强制使用 UTF-8 解码源文件。

### 5.23 改进：任务列表“启用”列交互与自动保存
- **需求**: 多工作簿任务列表中的“启用”列仅显示文本“是/否”，无法直接操作，且无相关功能入口。用户修改任务启用状态后需即时生效并保存。
- **实现**:
  - **交互优化**: 在 `MainWindow.cpp` 中将任务树（`QTreeWidget`）的“启用”列渲染方式从静态文本改为 `QCheckBox`，允许用户直接勾选/取消勾选。
  - **实时更新**: 连接 `QCheckBox` 的 `stateChanged` 信号，实时更新核心处理器中对应任务的 `enabled` 状态。
  - **自动保存**: 在复选框状态改变时，若当前已加载配置文件，自动触发 `saveConfiguration`，确保任务的启用/禁用状态立即持久化到磁盘，防止重启后丢失设置。

### 5.24 改进：授权逻辑优化
- **需求**:
  - 用户希望默认首次使用的电脑可试用 1 年。
  - 用户询问激活码激活后是否从激活时刻开始计算。
- **实现**:
  - 修改 `LicenseManager::getExpiryDate` 逻辑：
    - 若未检测到有效授权或过期，优先检查注册表中是否存在“首次运行时间” (`FirstRunDate`)。
    - 若不存在“首次运行时间”，则将其设置为当前时间，并自动授予 1 年试用期 (`FirstRunDate` + 1 年)。
    - 若存在，则基于该时间计算试用期，确保试用期不会因删除过期时间配置而被重置。
  - 确认激活逻辑：`activateWithCode` 保持原设计，即激活时从**当前时刻** (`currentDateTime`) 起延长 1 年，符合用户预期。

### 5.25 修复：分块处理时非首块表头错位
- **问题描述**: 在处理大型 Excel 文件（触发分块读取）时，除第一块外的后续数据块可能出现表头识别错误或数据顺序混乱。
- **原因分析**: `ExcelProcessorCore` 中的 `optimizeProcessing` 函数为了优化数据处理，对数据块进行了基于行长度的排序 (`std::sort`)。这破坏了数据行的原始物理顺序，导致后续分块中如果包含表头（或被误判为表头）时，无法正确保持位置。
- **修复方法**: 在 `processTasksInternal` 中禁用了 `dataProcessor_->optimizeProcessing` 调用，确保数据严格按照 Excel 文件中的物理顺序进行处理。

### 5.26 修复：Excel 组件加载失败无日志
- **问题描述**: 当 Excel 应用程序初始化失败（如 `ActiveQt` 创建失败）时，程序静默退出或仅在调试控制台输出，界面无错误提示。
- **原因分析**: `ActiveQtExcelReader::readExcelFile` 的错误处理分支中，仅调用了 `qDebug()`，未调用通过 `setLogger` 传入的回调函数，导致错误信息未传递给 UI 层。
- **修复方法**: 在所有关键错误路径（如 `excel.isNull()`, `workbooks.isNull()` 等）补充 `if (logger_) logger_(...)` 调用，确保错误信息能在主界面日志框中显示。

### 5.27 优化：操作区域界面布局调整
- **需求**: 用户反馈操作区域的“预览数据”按钮无效，建议移除；同时询问是否调整右侧“开始处理”按钮。
- **原因分析**: “预览数据”按钮在代码中未连接任何功能（代码被注释），且功能已被任务列表右键菜单和预览标签页覆盖，属于冗余控件。
- **实现**:
  - 移除了 `MainWindow` 底部操作区的“预览数据”按钮。
  - 调整“开始处理”按钮布局，使其独占操作区并自适应宽度，同时微调样式（略微增大字号），使其作为核心操作入口更加醒目。

### 5.28 新增：关于界面简易使用说明
- **需求**: 用户希望在“关于”界面增加简易的使用说明，指导新用户如何使用规则配置和多任务功能。
- **实现**:
  - 在 `MainWindow::createAboutTab` 中新增了一个 `QGroupBox`。
  - 添加了三条核心使用指引：
    1. 在“规则配置”界面创建规则。
    2. 在“多工作簿任务”界面应用规则。
    3. 利用多配置文件管理不同需求。
  - 优化了排版布局，使用 HTML 格式增强可读性。
