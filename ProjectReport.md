# Excel 处理工具项目报告

## 1. 项目概述
本项目是一个基于 Qt 5.12.12 和 C++ 开发的 Excel 数据处理工具，旨在提供灵活的规则配置、数据预览和自动化处理功能。项目采用 CMake 构建，支持 Windows 环境（Visual Studio 2026）。

## 2. 开发环境
- **操作系统**: Windows 10
- **IDE**: Visual Studio 2026
- **Qt 版本**: 5.12.12 (MSVC 2017 64-bit)
- **构建工具**: CMake + Ninja/NMake

## 3. 核心模块架构
### 3.1 核心逻辑 (`src/core`)
- **`ExcelProcessorCore`**: 核心处理引擎，负责 Excel 文件的读取、写入和任务调度。
- **`RuleEngine`**: 规则引擎，解析和执行用户定义的过滤/处理规则。
- **`RuleCombinationEngine`**: 负责多规则的组合逻辑。

### 3.2 图形界面 (`src/gui`)
- **`MainWindow`**: 主窗口，包含任务列表、规则列表、日志输出和预览面板。
- **`RuleEditDialog`**: 规则编辑对话框，支持多种规则类型的配置。

## 4. 功能特性
- **多模式处理**: 支持覆盖原工作表、新建工作表、新建工作簿等多种输出模式。
- **规则系统**: 支持“保留”、“删除”、“替换”等多种规则，支持多条件组合。
- **实时预览**: 能够预览 Excel 数据及规则应用后的效果。
- **日志系统**: 提供详细的操作日志，支持错误追踪。
- **配置持久化**: 自动保存和加载用户配置的任务和规则。

## 5. 开发日志与问题修复

### 5.1 初始开发
- 搭建 CMake 项目结构。
- 实现基础的 Excel 读取 (ActiveQt) 和写入功能。
- 实现 Qt 界面原型。

### 5.2 修复：规则应用逻辑
- **问题**: 多个规则按顺序应用时，数据状态未正确更新。
- **修复**: 重构 `RuleEngine::applyRules`，确保每条规则基于上一条规则的输出进行处理。

### 5.3 优化：大文件处理性能
- **问题**: 读取大型 Excel 文件时界面卡顿。
- **优化**: 引入分块读取 (Chunked Reading) 机制，配合多线程处理，保持界面响应。

### 5.4 修复：中文乱码问题
- **问题**: 规则名称和日志中的中文显示为乱码。
- **修复**: 统一使用 UTF-8 编码源文件，并在 CMake 中添加 `/utf-8` 编译选项。

### 5.5 新增：预览功能增强
- **需求**: 用户希望在预览时看到原始数据和处理后数据的对比。
- **实现**: 在 `MainWindow` 中添加两个 `QTableWidget`，分别显示输入预览和输出预览。

### 5.6 修复：输出模式“覆盖原工作表”逻辑
- **问题**: 选择覆盖原工作表时，程序错误地清空了整个文件。
- **修复**: 修改 `ActiveQtExcelWriter`，使用 `UsedRange.Clear()` 而不是删除 Sheet，保留了 Sheet 结构。

### 5.7 修复：规则添加成功提示乱码
- **问题描述**: 用户反馈添加规则成功后的提示框中出现乱码。
- **原因分析**: 源代码文件编码与编译器执行字符集不匹配，或 `QMessageBox` 未正确处理字符串编码。
- **修复方法**: 确保源文件为 UTF-8 BOM 格式，并使用 `QString::fromLocal8Bit` 或直接使用宽字符（如果适用）来处理中文字符串。在本项目中，统一确保源文件 UTF-8 编码并正确使用 Qt 的字符串处理机制。

### 5.8 修复：预览数据累加问题
- **问题描述**: 多次点击预览时，新的预览数据会追加在旧数据后面，而不是替换。
- **原因分析**: `getTaskPreviewData` 或 UI 更新逻辑中，未在填充新数据前清空容器或表格。
- **修复方法**: 在 `MainWindow::previewTask` 中，在加载新数据前调用 `previewInputTable_->setRowCount(0)` 和 `previewOutputTable_->setRowCount(0)` 清空表格。

### 5.9 修复：单独点击输出规则表头缺失
- **问题描述**: 当用户未点击“预览”而直接点击规则列表中的规则进行单步调试/输出时，结果中缺失表头。
- **原因分析**: 单步规则处理逻辑直接使用了 `processData` 对数据行进行处理，而未考虑到第一行可能是表头（需要特殊保留或处理）。
- **修复方法**: 在规则处理逻辑中增加对表头的判断。如果任务配置为 `useHeader`，则在处理第一行时将其标记为表头，不应用过滤/删除规则（除非规则显式针对表头）。

### 5.10 修复：预览界面缺失表头问题
- **问题描述**: 预览界面（输入和输出）均不显示 Excel 的表头行，导致用户难以对应列数据。
- **原因分析**: `ExcelProcessorCore::getTaskPreviewData` 在读取数据时，默认可能跳过了第一行（视作表头但未返回给 UI），或者 UI 在渲染时未将第一行数据设置为 `QTableWidget` 的 Header。
- **修复方法**: 修改数据读取逻辑，确保预览数据包含表头行。在 `MainWindow` 中，将读取到的第一行数据提取出来，使用 `setHorizontalHeaderLabels` 设置为表格的列头。

### 5.11 修复：刷新预览导致信息丢失
- **问题描述**: 用户在修改规则后点击刷新预览，之前的输入源/输出目标等上下文信息丢失，或预览内容未正确更新。
- **原因分析**: 刷新操作可能重新触发了完整的数据读取流程，但未保留当前选中的任务上下文。
- **修复方法**: 优化 `previewTask` 流程，确保在刷新时重新读取当前选中任务的配置，并保持界面状态一致。

### 5.12 改进：预览界面信息显示
- **需求**: 在预览界面清晰展示当前预览的是哪个文件（输入源）以及应用了哪些规则（输出规则）。
- **实现**: 
  - 在预览面板顶部增加 `QLabel`，显示“输入源: [文件名]”。
  - 增加显示“当前预览规则: [规则名称]”的标签。
  - 改进：在文件名后增加工作表名称，格式为“输入源: [文件名] / [工作表名]”。

### 5.13 修复：项目报告章节顺序错误
- **问题**: 项目报告中章节编号混乱（如 5.15 在 5.16 后）。
- **修复**: 重新整理 `ProjectReport.md`，按时间顺序和逻辑关系调整章节编号。

### 5.14 修复：编译错误 (Terminal#404-566)
- **问题描述**: 终端报错 `C2039: 'sheetName': is not a member of 'ProcessingTask'`。
- **原因分析**: 代码中引用了 `task.sheetName`，但 `ProcessingTask` 结构体的实际成员名为 `inputSheetName`。
- **修复方法**: 将 `MainWindow.cpp` 中所有错误的 `task.sheetName` 引用更正为 `task.inputSheetName`。

### 5.15 新增：程序图标
- **需求**: 为程序创建一个图标，构想为绿色背景上的大写字母 "E"，并要求设计更加绚丽，且调整 "E" 的笔画间距以避免拥挤。
- **实现**:
  - 编写 Python 脚本 `generate_icon.py`，使用 Pillow 库绘制图标。

### 5.16 修复：非首块数据表头丢失与日志提示缺失
- **问题描述**:
  1. 勾选“使用原输入文件表头”时，处理大量数据（分块处理）时，非首块数据的表头逻辑处理错误，导致后续数据块处理时表头可能被错误丢弃或作为数据处理。实际表现为输出文件表头内容变成了数据行。
  2. 当输入文件不存在或指定工作表不存在时，程序日志中未输出明确的提示信息，而是直接显示任务完成，导致用户困惑。
- **原因分析**:
  1. **表头问题**: `HighPerformanceDataProcessor::optimizeProcessing` 方法在处理数据块时对数据进行了排序优化（`std::sort`），导致作为数据第一行的表头被移动到了数据中间，从而破坏了表头结构。此外，`processTasksInternal` 在处理非首块数据时，未正确传递 `includeHeader` 参数。
  2. **日志问题**: `ActiveQtExcelReader::readExcelFile` 在遇到文件打开失败或 Sheet 未找到时，虽然使用了 `qDebug()` 输出调试信息，但未调用 `logger_` 回调函数，导致 GUI 日志窗口无法捕获这些关键错误。
- **修复方法**:
  1. **禁用排序优化**: 在 `processTasksInternal` 中禁用了 `dataProcessor_->optimizeProcessing` 调用，确保数据（尤其是包含表头的首块数据）保持原始顺序。
  2. **完善错误日志**: 在 `ActiveQtExcelReader::readExcelFile` 的关键错误分支（创建 Excel 对象失败、打开工作簿失败、未找到工作表）中增加了 `logger_` 调用，确保错误信息能实时输出到用户界面日志中。
